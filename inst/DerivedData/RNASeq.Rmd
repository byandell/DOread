---
title: "RNASeq"
author: "Brian S. Yandell"
date: "3/23/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
suppressPackageStartupMessages({
  library(DOread)
  library(feather)
  library(readxl)
})
```

```{r}
datapath <- "~/Documents/Research/attie_alan/DO/"
dirpath <- file.path(datapath, "data", "DerivedData")
```

```{r}
load(file.path(datapath, "rna_seq", "DO381_islet.RData"))
```

```{r}
ls()
```

```{r}
annot.samples$Mouse.ID <- stringr::str_replace(annot.samples$Mouse.ID, "DO-0*", "")
head(annot.samples)
```

```{r}
head(annot.mrna)
```

Save annotations in RDS files.

```{r}
if(!dir.exists(file.path(dirpath, "RNAseq")))
  dir.create(file.path(dirpath, "RNAseq"))
```

```{r}
saveRDS(annot.mrna, file = file.path(dirpath, "RNAseq", "annot.mrna.rds"))
```

There are mouse duplicates. Throw them all out.

```{r}
(dupes <- sort(unique(c(which(duplicated(annot.samples$Mouse.ID)),
                  which(duplicated(annot.samples$Mouse.ID, fromLast = TRUE))))))
```

```{r}
if(length(dupes)) {
  annot.samples <- annot.samples[-dupes, ]
  expr.mrna <- expr.mrna[-dupes, ]
}
```

```{r}
saveRDS(annot.samples,
        file = file.path(dirpath, "RNAseq", "annot.samples.rds"))
```

Save `expr.mrna` in feather file. First create mouse ID column

```{r}
expr.mrna <- data.frame(Mouse.ID = annot.samples$Mouse.ID, expr.mrna,
                        stringsAsFactors = FALSE)
```


```{r}
write_feather(expr.mrna, file.path(dirpath, "RNAseq", "expr.mrna.feather"))
```

## Expression Peaks

```{r}
system.time(peaks <- read_excel(file.path(datapath, "rna_seq", "all_suggestive_qtls_mrna.xlsx")))
```

```{r}
table(table(peaks$gene_id))
```

```{r}
write_feather(peaks, file.path(dirpath, "RNAseq", "peaks.mrna.feather"))
```

```{r}
system.time(peaks <- read_feather(file.path(dirpath, "RNAseq", "peaks.mrna.feather")))
```

